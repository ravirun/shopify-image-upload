(()=>{var e={};e.id=827,e.ids=[827],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},9288:e=>{"use strict";e.exports=require("sharp")},9428:e=>{"use strict";e.exports=require("buffer")},9021:e=>{"use strict";e.exports=require("fs")},1630:e=>{"use strict";e.exports=require("http")},5591:e=>{"use strict";e.exports=require("https")},3873:e=>{"use strict";e.exports=require("path")},7910:e=>{"use strict";e.exports=require("stream")},9551:e=>{"use strict";e.exports=require("url")},8354:e=>{"use strict";e.exports=require("util")},3566:e=>{"use strict";e.exports=require("worker_threads")},4573:e=>{"use strict";e.exports=require("node:buffer")},3024:e=>{"use strict";e.exports=require("node:fs")},7067:e=>{"use strict";e.exports=require("node:http")},4708:e=>{"use strict";e.exports=require("node:https")},7030:e=>{"use strict";e.exports=require("node:net")},4379:e=>{"use strict";e.exports=require("node:path")},1708:e=>{"use strict";e.exports=require("node:process")},7075:e=>{"use strict";e.exports=require("node:stream")},7830:e=>{"use strict";e.exports=require("node:stream/web")},3136:e=>{"use strict";e.exports=require("node:url")},7975:e=>{"use strict";e.exports=require("node:util")},8522:e=>{"use strict";e.exports=require("node:zlib")},9388:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>b,routeModule:()=>w,serverHooks:()=>v,workAsyncStorage:()=>q,workUnitAsyncStorage:()=>S});var o={};t.r(o),t.d(o,{POST:()=>y});var s=t(2706),i=t(8203),a=t(5994),u=t(9187),n=t(7921),p=t(1153),c=t.n(p),l=t(9288),d=t.n(l);let m=process.env.SHOPIFY_STORE_URL,f=process.env.SHOPIFY_ACCESS_TOKEN,g=async e=>{try{console.time(`Fetch Product By SKU ${e}`);let r=`${m}/admin/api/2023-10/products.json?fields=id,variants`,t=await (0,n.Ay)(r,{method:"GET",headers:{"X-Shopify-Access-Token":f,"Content-Type":"application/json"}});if(!t.ok)throw Error(`Failed to fetch products: ${t.statusText}`);let o=await t.json();if(!o.products||0===o.products.length)throw Error("No products found.");for(let r of o.products){let t=r.variants.find(r=>r.sku===e);if(t)return console.log("Product found by SKU:",r),console.timeEnd(`Fetch Product By SKU ${e}`),{product:r,variant:t}}throw Error(`No product found with SKU: ${e}`)}catch(e){throw console.error("Error fetching product by SKU from Shopify:",e.message),e}},h=async(e,r)=>{try{console.time(`Convert Image ${r} to WebP`);let t=r.split(".").pop().toLowerCase();if("webp"===t)return console.log("Image is already in WebP format, skipping conversion."),console.timeEnd(`Convert Image ${r} to WebP`),e;let o=await d()(e).webp({quality:80,lossless:!1,alphaQuality:80,nearLossless:!0}).toBuffer();return o.length>3145728&&(console.log("Image exceeds 3MB. Reducing quality further."),o=await d()(o).webp({quality:60}).toBuffer()),console.timeEnd(`Convert Image ${r} to WebP`),o}catch(e){throw console.error("Error converting image to WebP:",e.message),e}},x=async(e,r,t)=>{try{console.time(`Upload Image ${t} to Shopify`);let o=`${m}/admin/api/2023-10/products/${e}/images.json`,s=new(c());s.append("image[attachment]",r.toString("base64")),s.append("image[filename]",t);let i=await (0,n.Ay)(o,{method:"POST",headers:{"X-Shopify-Access-Token":f},body:s});if(!i.ok)throw Error(`Failed to upload image: ${i.statusText}`);let a=await i.json();return console.log("Shopify response:",a),console.timeEnd(`Upload Image ${t} to Shopify`),a.image||null}catch(e){throw console.error("Error uploading image to Shopify:",e.message),e}},y=async e=>{try{let r=await e.formData(),t={};for(let[e,o]of(console.log("Received form data:",r),r.entries())){let r=e.split("/")[0];console.log(`Received SKU: ${r}`),console.time(`Total Time for SKU ${r}`);let{product:s}=await g(r);if(s){let e=Buffer.from(await o.arrayBuffer());console.log(`Preparing to upload image for SKU ${r} to Shopify`);let i=await h(e,o.name),a=await x(s.id,i,o.name);console.log(`Image uploaded successfully: ${a}`),t[r]||(t[r]=[]),t[r].push(a)}else console.log(`No product found for SKU: ${r}`);console.timeEnd(`Total Time for SKU ${r}`)}return console.log("Folder uploads:",t),u.NextResponse.json({message:"Images uploaded successfully.",folderUploads:t})}catch(e){return console.error("Error during image upload:",e.message),u.NextResponse.json({error:e.message},{status:500})}},w=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/upload/sku/route",pathname:"/api/upload/sku",filename:"route",bundlePath:"app/api/upload/sku/route"},resolvedPagePath:"/Users/ravisharma/bulk-image-uploader/shopify-image-upload/src/app/api/upload/sku/route.js",nextConfigOutput:"",userland:o}),{workAsyncStorage:q,workUnitAsyncStorage:S,serverHooks:v}=w;function b(){return(0,a.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:S})}},6487:()=>{},8335:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[613,452,302,153],()=>t(9388));module.exports=o})();