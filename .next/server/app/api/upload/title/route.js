(()=>{var e={};e.id=266,e.ids=[266],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},9288:e=>{"use strict";e.exports=require("sharp")},9428:e=>{"use strict";e.exports=require("buffer")},9021:e=>{"use strict";e.exports=require("fs")},1630:e=>{"use strict";e.exports=require("http")},5591:e=>{"use strict";e.exports=require("https")},3873:e=>{"use strict";e.exports=require("path")},7910:e=>{"use strict";e.exports=require("stream")},9551:e=>{"use strict";e.exports=require("url")},8354:e=>{"use strict";e.exports=require("util")},3566:e=>{"use strict";e.exports=require("worker_threads")},4573:e=>{"use strict";e.exports=require("node:buffer")},3024:e=>{"use strict";e.exports=require("node:fs")},7067:e=>{"use strict";e.exports=require("node:http")},4708:e=>{"use strict";e.exports=require("node:https")},7030:e=>{"use strict";e.exports=require("node:net")},6760:e=>{"use strict";e.exports=require("node:path")},1708:e=>{"use strict";e.exports=require("node:process")},7075:e=>{"use strict";e.exports=require("node:stream")},7830:e=>{"use strict";e.exports=require("node:stream/web")},3136:e=>{"use strict";e.exports=require("node:url")},7975:e=>{"use strict";e.exports=require("node:util")},8522:e=>{"use strict";e.exports=require("node:zlib")},4133:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>N,routeModule:()=>$,serverHooks:()=>k,workAsyncStorage:()=>T,workUnitAsyncStorage:()=>v});var s={};r.r(s),r.d(s,{POST:()=>j});var o=r(2706),i=r(8203),a=r(5994),n=r(9187),u=r(7921),p=r(1153),l=r.n(p),c=r(9288),d=r.n(c);let m=async(e,t,r=5)=>{for(let s=0;s<r;s++){let r=await (0,u.Ay)(e,t);if(429===r.status){let e=1e3*parseInt(r.headers.get("Retry-After")||"1",10);console.log(`Rate limit hit, retrying after ${e}ms...`),await new Promise(t=>setTimeout(t,e));continue}if(r.ok)return r;throw Error(`Request failed: ${r.statusText}`)}throw Error("Maximum retries exceeded.")},f=async(e,t,r)=>{let s=`${t}/admin/api/2023-10/products.json?title=${encodeURIComponent(e)}`,o=await m(s,{method:"GET",headers:{"X-Shopify-Access-Token":r,"Content-Type":"application/json"}});return(await o.json()).products[0]||null},g=async(e,t)=>{if("webp"===t.split(".").pop().toLowerCase())return e;let r=await d()(e).webp({quality:80}).toBuffer();return r.length>3145728&&(r=await d()(r).webp({quality:60}).toBuffer()),r},h=async(e,t,r,s,o,i)=>{let a=`${s}/admin/api/2023-10/products/${e}/images.json`,n=new(l());n.append("image[attachment]",t.toString("base64")),n.append("image[filename]",r),n.append("image[position]",i);let u=await m(a,{method:"POST",headers:{"X-Shopify-Access-Token":o},body:n});return(await u.json()).image||null},w=async(e,t)=>{let r=[],s=[];for(let o of e){let e=o().then(e=>{r.push(e)});s.push(e),s.length>=t&&(await Promise.race(s),s.splice(s.findIndex(t=>t===e),1))}return await Promise.all(s),r},x=async(e,t,r,s)=>{let o=`${r}/admin/api/2023-10/products/${e}.json`,i=await m(o,{method:"GET",headers:{"X-Shopify-Access-Token":s,"Content-Type":"application/json"}});if(!i.ok)throw Error(`Failed to fetch product: ${i.statusText}`);let a=(await i.json()).product;if(a){let e=a.variants.filter(e=>e.title.toLowerCase().includes(t.toLowerCase()));if(e.length>0)return{product:a,variants:e}}return null},y=async(e,t,r,s,o,i)=>{let a=await x(e,t,o,i);if(!a)throw Error(`No product found with variant name: ${t}`);let{product:n,variants:u}=a,p={image:{attachment:(await g(r,s)).toString("base64"),filename:s,variant_ids:u.map(e=>e.id)}},l=`${o}/admin/api/2023-10/products/${n.id}/images.json`,c={method:"POST",headers:{"X-Shopify-Access-Token":i,"Content-Type":"application/json"},body:JSON.stringify(p)},d=await m(l,c),f=await d.json();if(!d.ok)throw console.error(`Error uploading image: ${JSON.stringify(f.errors)}`),Error("Failed to upload image");return f.image},q=async(e,t,r,s,o,i)=>{try{let a=await y(e,t,r,s,o,i);console.log("Image successfully uploaded:",a)}catch(e){console.error("Error uploading image:",e.message)}},j=async e=>{try{let t=await e.formData(),r=t.get("storeUrl"),s=t.get("apiKey");if(!r||!s)return n.NextResponse.json({error:"Shopify credentials missing"},{status:400});let o=Date.now(),i={},a=[];for(let[e,o]of t.entries())a.push(async()=>{let t=Date.now(),a=e.split("/")[0],n=await f(a,r,s);if(!n){console.log(`No product found for title: ${a}`);return}let u=Buffer.from(await o.arrayBuffer()),p=await g(u,o.name),l=o.name.split("/").pop(),c=l.split(".")[0],d=isNaN(c)?"NaN":Number(c);if(isNaN(d))console.log(`The position for ${l} is NaN. Uploading to variant.`),await q(n.id,l.split(".")[0],u,l,r,s);else{let e=await h(n.id,p,o.name,r,s,d);i[a]=i[a]||[],i[a].push(e)}console.log(`Processed ${a} in ${Date.now()-t}ms`)});return await w(a,5),console.log(`Overall processing time: ${Date.now()-o}ms`),n.NextResponse.json({message:"Images uploaded successfully.",folderUploads:i,processingTime:`${Date.now()-o}ms`})}catch(e){return console.error("Error during image upload:",e.message),n.NextResponse.json({error:e.message},{status:500})}},$=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/upload/title/route",pathname:"/api/upload/title",filename:"route",bundlePath:"app/api/upload/title/route"},resolvedPagePath:"/Users/ravisharma/bulk-image-uploader/shopify-image-upload/src/app/api/upload/title/route.js",nextConfigOutput:"",userland:s}),{workAsyncStorage:T,workUnitAsyncStorage:v,serverHooks:k}=$;function N(){return(0,a.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:v})}},6487:()=>{},8335:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[613,452,302,153],()=>r(4133));module.exports=s})();